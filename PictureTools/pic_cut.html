<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>批量图片裁剪工具</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "sphx0kqwdu");
  </script>
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        neutral: '#1F2937',
                        dark: '#111827',
                        light: '#F3F4F6'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .transition-height {
                transition: max-height 0.3s ease-in-out;
            }
            .shadow-soft {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .dark-shadow-soft {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            }
        }
    </style>
    
    <style>
        /* 暗色模式变量 */
        :root {
            --bg-color: #F3F4F6;
            --bg-gradient: linear-gradient(to-br, #F3F4F6, #E5E7EB);
            --card-bg: #FFFFFF;
            --text-color: #1F2937;
            --text-secondary: #4B5563;
            --border-color: #E5E7EB;
        }
        
        .dark-mode {
            --bg-color: #111827;
            --bg-gradient: linear-gradient(to-br, #111827, #1F2937);
            --card-bg: #1F2937;
            --text-color: #F9FAFB;
            --text-secondary: #D1D5DB;
            --border-color: #374151;
        }
        
        body {
            background-color: var(--bg-color);
            background-image: var(--bg-gradient);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .card {
            background-color: var(--card-bg);
            transition: background-color 0.3s ease;
        }
        
        .text-secondary {
            color: var(--text-secondary);
        }
        
        input, canvas {
            border-color: var(--border-color);
            color: var(--text-color);
            background-color: var(--card-bg);
            transition: border-color 0.3s ease, background-color 0.3s ease, color 0.3s ease;
        }
        
        /* 自定义滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-color);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        
        /* 隐藏文件输入框 */
        input[type="file"] {
            display: none;
        }

        /* 裁剪框样式 */
        #crop-box {
            border: 2px dashed #EF4444;
            cursor: move;
        }

        /* 自定义按钮样式 */
        .btn {
            @apply px-4 py-2 font-semibold text-white rounded-lg transition-all duration-200 shadow-md transform hover:scale-[1.02] active:scale-[0.98];
        }
        .btn-primary {
            @apply bg-primary hover:bg-primary/90 active:bg-primary/80;
        }
        .btn-secondary {
            @apply bg-secondary hover:bg-secondary/90 active:bg-secondary/80;
        }
        .btn-neutral {
            @apply bg-neutral hover:bg-neutral/90 active:bg-neutral/80;
        }
        .btn-red {
            @apply bg-red-600 hover:bg-red-700 active:bg-red-800;
        }
    </style>
</head>
<body class="min-h-screen font-sans">
    <!-- 顶部操作按钮 -->
    <div class="container mx-auto px-4 py-4 max-w-6xl flex justify-end gap-3">
        <!-- 添加返回主页按钮 -->
        <button id="homeButton" class="flex items-center justify-center gap-2 bg-primary/10 hover:bg-primary/20 text-primary px-4 py-2 rounded-lg transition-all">
            <i class="fa fa-home"></i>
            <span>返回主页</span>
        </button>
        <button id="themeToggle" class="flex items-center justify-center bg-primary/10 hover:bg-primary/20 text-primary w-10 h-10 rounded-lg transition-all">
            <i id="themeIcon" class="fa fa-moon-o"></i>
        </button>
    </div>

    <div class="container mx-auto px-4 pb-8 max-w-6xl">
        <!-- 标题部分 -->
        <header class="text-center mb-10">
            <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold mb-3 tracking-tight">
                <span class="text-primary">图片</span>裁剪工具
            </h1>
            <p class="text-secondary max-w-2xl mx-auto text-lg">
                上传图片，自定义裁剪比例，批量处理并下载，简单高效
            </p>
        </header>
        
        <!-- 主要内容区 -->
        <main class="card rounded-2xl shadow-soft p-6 md:p-8 mb-10 transform transition-all duration-300 hover:shadow-lg">
            <div class="w-full flex flex-col lg:flex-row gap-8">
                <!-- 左侧控制面板和图片列表 -->
                <div class="w-full lg:w-1/3 flex flex-col gap-6">
                    <!-- 文件上传区域 -->
                    <div class="p-6 bg-light/50 border border-border-color rounded-xl shadow-inner">
                        <label for="fileInput" class="cursor-pointer">
                            <div class="flex flex-col items-center justify-center p-8 border-2 border-dashed border-primary/50 rounded-xl text-center hover:bg-primary/5 transition-colors duration-200">
                                <i class="fa fa-cloud-upload text-4xl text-primary mb-3"></i>
                                <span class="text-lg font-bold text-primary">点击上传图片</span>
                                <span class="text-sm text-secondary mt-1">支持批量上传</span>
                                <input type="file" id="fileInput" multiple accept="image/*">
                            </div>
                        </label>
                    </div>
                    
                    <!-- 图片列表 -->
                    <div class="flex-grow bg-light/50 border border-border-color rounded-xl shadow-inner p-4 overflow-y-auto max-h-[400px]">
                        <h2 class="text-xl font-bold mb-4 text-text-color flex items-center">
                            <i class="fa fa-th-large mr-2 text-primary"></i>已上传图片
                        </h2>
                        <div id="thumbnails" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                            <!-- 缩略图将在这里动态添加 -->
                        </div>
                        <div id="no-images" class="text-center py-10 text-secondary">
                            <i class="fa fa-picture-o text-4xl mb-3 opacity-50"></i>
                            <p>尚未上传图片</p>
                        </div>
                    </div>

                    <!-- 裁剪比例设置 -->
                    <div class="p-6 bg-light/50 border border-border-color rounded-xl shadow-inner">
                        <h2 class="text-xl font-bold mb-4 text-text-color flex items-center">
                            <i class="fa fa-crop mr-2 text-primary"></i>裁剪比例
                        </h2>
                        <div class="flex flex-col gap-4">
                            <!-- 预设比例 -->
                            <div class="flex flex-wrap gap-2">
                                <button class="ratio-btn bg-light hover:bg-primary/20 text-text-color px-3 py-1 rounded-full text-sm transition-colors duration-200" data-ratio="1/1">1:1</button>
                                <button class="ratio-btn bg-light hover:bg-primary/20 text-text-color px-3 py-1 rounded-full text-sm transition-colors duration-200" data-ratio="16/9">16:9</button>
                                <button class="ratio-btn bg-light hover:bg-primary/20 text-text-color px-3 py-1 rounded-full text-sm transition-colors duration-200" data-ratio="4/3">4:3</button>
                                <button class="ratio-btn bg-light hover:bg-primary/20 text-text-color px-3 py-1 rounded-full text-sm transition-colors duration-200" data-ratio="0">自由</button>
                            </div>
                            <!-- 自定义比例 -->
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-secondary">自定义:</label>
                                <input type="number" id="ratio-w" placeholder="宽" class="w-20 px-2 py-1 border border-border-color rounded-md text-sm focus:ring-primary/50 focus:border-primary">
                                <span class="text-secondary">:</span>
                                <input type="number" id="ratio-h" placeholder="高" class="w-20 px-2 py-1 border border-border-color rounded-md text-sm focus:ring-primary/50 focus:border-primary">
                                <button id="set-ratio" class="btn btn-primary text-sm px-3 py-1">应用</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右侧图片显示和操作区 -->
                <div class="w-full lg:w-2/3 flex flex-col gap-6">
                    <!-- 图片预览区 -->
                    <div class="relative bg-light/50 border border-border-color rounded-xl shadow-inner overflow-hidden flex items-center justify-center min-h-[300px]">
                        <div id="preview-placeholder" class="text-center text-secondary">
                            <i class="fa fa-image text-6xl mb-3 opacity-50"></i>
                            <p>请上传图片并选择要裁剪的图片</p>
                        </div>
                        <canvas id="main-canvas" class="max-w-full max-h-full hidden"></canvas>
                        <!-- 裁剪框，确保它是相对定位的父元素的子元素，以便正确计算位置 -->
                        <div id="crop-box" class="absolute hidden" style="pointer-events: none;"></div>
                    </div>

                    <!-- 底部操作按钮和下载区 -->
                    <div class="flex flex-col gap-4">
                        <div class="flex flex-wrap gap-4 justify-center">
                            <button id="crop-button" class="btn btn-primary flex items-center gap-2">
                                <i class="fa fa-scissors"></i>
                                <span>裁剪当前图片</span>
                            </button>
                            <!-- 添加裁剪全部图片按钮 -->
                            <button id="crop-all-button" class="btn btn-primary flex items-center gap-2">
                                <i class="fa fa-scissors"></i>
                                <span>裁剪全部图片</span>
                            </button>
                            <button id="download-all-button" class="btn btn-secondary flex items-center gap-2">
                                <i class="fa fa-download"></i>
                                <span>批量下载</span>
                            </button>
                            <button id="clear-all" class="btn btn-neutral flex items-center gap-2">
                                <i class="fa fa-trash"></i>
                                <span>清空所有</span>
                            </button>
                        </div>

                        <!-- 下载区域 -->
                        <div id="download-container" class="mt-4 p-4 bg-light/50 rounded-xl border border-border-color overflow-y-auto max-h-[200px] hidden">
                            <h3 class="text-xl font-bold mb-4 text-text-color flex items-center">
                                <i class="fa fa-check-circle mr-2 text-secondary"></i>处理结果
                            </h3>
                            <div id="download-list" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                                <!-- 裁剪后的图片将在这里显示 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- 功能说明 -->
        <section class="card rounded-2xl shadow-soft p-6 md:p-8 mb-10">
            <h2 class="text-xl font-bold mb-6 flex items-center">
                <i class="fa fa-info-circle text-primary mr-2"></i>功能说明
            </h2>
            <div class="grid md:grid-cols-3 gap-6">
                <div class="flex gap-4">
                    <div class="text-primary text-2xl mt-1">
                        <i class="fa fa-cloud-upload"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg mb-1">上传图片</h3>
                        <p class="text-secondary">支持批量上传多张图片，点击上传区域即可选择本地图片文件</p>
                    </div>
                </div>
                <div class="flex gap-4">
                    <div class="text-primary text-2xl mt-1">
                        <i class="fa fa-crop"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg mb-1">裁剪设置</h3>
                        <p class="text-secondary">支持多种预设比例和自定义比例，拖动鼠标选择裁剪区域</p>
                    </div>
                </div>
                <div class="flex gap-4">
                    <div class="text-secondary text-2xl mt-1">
                        <i class="fa fa-download"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg mb-1">下载图片</h3>
                        <p class="text-secondary">可以单独下载裁剪后的图片，也可以选择批量下载所有处理结果</p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- 页脚 -->
        <footer class="text-center text-secondary text-sm py-4">
            <p>© 2025 图片裁剪工具 | 一个简单实用的图片处理工具</p>
            <p>Ver. 1.0.20250805</p>
        </footer>
    </div>
    
    <!-- 通知提示 -->
    <div id="notification" class="fixed bottom-5 right-5 bg-neutral text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center gap-2 z-50">
        <i class="fa fa-check-circle"></i>
        <span id="notificationText">操作成功</span>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const thumbnailsContainer = document.getElementById('thumbnails');
        const noImagesPlaceholder = document.getElementById('no-images');
        const mainCanvas = document.getElementById('main-canvas');
        const previewPlaceholder = document.getElementById('preview-placeholder');
        const cropBox = document.getElementById('crop-box');
        const ratioButtons = document.querySelectorAll('.ratio-btn');
        const customRatioW = document.getElementById('ratio-w');
        const customRatioH = document.getElementById('ratio-h');
        const setRatioButton = document.getElementById('set-ratio');
        const cropButton = document.getElementById('crop-button');
        const cropAllButton = document.getElementById('crop-all-button'); // 新增裁剪全部按钮
        const downloadAllButton = document.getElementById('download-all-button');
        const clearAllButton = document.getElementById('clear-all');
        const downloadContainer = document.getElementById('download-container');
        const downloadList = document.getElementById('download-list');
        const homeButton = document.getElementById('homeButton'); // 新增返回主页按钮
        
        // 主题相关元素
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notificationText');

        let allImages = []; // Stores information for all uploaded images
        let currentImageIndex = -1;
        let cropRatio = 0; // 0 for free crop

        let isDragging = false;
        let startX, startY;
        let cropX = 0, cropY = 0, cropW = 0, cropH = 0;

        // Initialize theme based on local storage or system preference
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.body.classList.add('dark-mode');
                themeIcon.classList.remove('fa-moon-o');
                themeIcon.classList.add('fa-sun-o');
                document.querySelectorAll('.shadow-soft').forEach(el => {
                    el.classList.remove('shadow-soft');
                    el.classList.add('dark-shadow-soft');
                });
            }
        }
        
        // Toggle between light and dark themes
        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-mode');
            
            if (isDark) {
                themeIcon.classList.remove('fa-moon-o');
                themeIcon.classList.add('fa-sun-o');
                document.querySelectorAll('.shadow-soft').forEach(el => {
                    el.classList.remove('shadow-soft');
                    el.classList.add('dark-shadow-soft');
                });
                localStorage.setItem('theme', 'dark');
            } else {
                themeIcon.classList.remove('fa-sun-o');
                themeIcon.classList.add('fa-moon-o');
                document.querySelectorAll('.dark-shadow-soft').forEach(el => {
                    el.classList.remove('dark-shadow-soft');
                    el.classList.add('shadow-soft');
                });
                localStorage.setItem('theme', 'light');
            }
            
            showNotification(isDark ? '已切换到暗色模式' : '已切换到亮色模式');
        }
        
        // Show a custom notification message
        function showNotification(message) {
            notificationText.textContent = message;
            notification.classList.remove('translate-y-20', 'opacity-0');
            notification.classList.add('translate-y-0', 'opacity-100');
            
            setTimeout(() => {
                notification.classList.remove('translate-y-0', 'opacity-100');
                notification.classList.add('translate-y-20', 'opacity-0');
            }, 2000);
        }

        // Handle file uploads
        fileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                // Clear existing images and lists
                allImages = [];
                thumbnailsContainer.innerHTML = '';
                downloadList.innerHTML = '';
                downloadContainer.classList.add('hidden');
                mainCanvas.classList.add('hidden');
                previewPlaceholder.classList.remove('hidden');
                noImagesPlaceholder.classList.add('hidden');
                
                let loadedCount = 0;
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            const newImage = {
                                original: img,
                                dataUrl: event.target.result,
                                name: file.name,
                                crop: { x: 0, y: 0, w: img.width, h: img.height }
                            };
                            allImages.push(newImage);
                            
                            // Create thumbnail
                            const thumbnailDiv = document.createElement('div');
                            thumbnailDiv.className = 'relative w-24 h-24 overflow-hidden rounded-lg cursor-pointer transition-transform duration-200 transform hover:scale-105 shadow-md border border-border-color';
                            thumbnailDiv.innerHTML = `<img src="${event.target.result}" class="w-full h-full object-cover">`;
                            thumbnailDiv.addEventListener('click', () => {
                                // Select the newly added image by its index
                                const index = allImages.findIndex(i => i.dataUrl === newImage.dataUrl);
                                selectImage(index);
                            });
                            thumbnailsContainer.appendChild(thumbnailDiv);

                            loadedCount++;
                            // Select the first image by default after all images are loaded
                            if (loadedCount === files.length) {
                                selectImage(0);
                                showNotification(`已成功上传 ${files.length} 张图片`);
                            }
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }
        });

        // Select an image and display it on the main canvas
        function selectImage(index) {
            currentImageIndex = index;
            const currentImage = allImages[currentImageIndex];
            const ctx = mainCanvas.getContext('2d');
            
            // Hide placeholder, show canvas
            previewPlaceholder.classList.add('hidden');
            mainCanvas.classList.remove('hidden');
            
            // Adjust canvas size to match image dimensions
            mainCanvas.width = currentImage.original.width;
            mainCanvas.height = currentImage.original.height;

            // Clear and draw the image
            ctx.clearRect(0, 0, mainCanvas.width, mainCanvas.height);
            ctx.drawImage(currentImage.original, 0, 0);

            // Update crop box based on saved crop data or default to full image
            const crop = currentImage.crop;
            cropX = crop.x;
            cropY = crop.y;
            cropW = crop.w;
            cropH = crop.h;
            updateCropBox();
            
            // Highlight the selected thumbnail
            const thumbnails = thumbnailsContainer.querySelectorAll('div');
            thumbnails.forEach((thumb, i) => {
                if (i === index) {
                    thumb.classList.add('ring-2', 'ring-primary');
                } else {
                    thumb.classList.remove('ring-2', 'ring-primary');
                }
            });
        }

        // Mousedown event for starting crop box drag
        mainCanvas.addEventListener('mousedown', (e) => {
            if (currentImageIndex === -1) return;

            const rect = mainCanvas.getBoundingClientRect();
            const scaleX = mainCanvas.width / rect.width;
            const scaleY = mainCanvas.height / rect.height;

            startX = (e.clientX - rect.left) * scaleX;
            startY = (e.clientY - rect.top) * scaleY;
            isDragging = true;

            // Initialize crop box size to 0
            cropX = startX;
            cropY = startY;
            cropW = 0;
            cropH = 0;
            updateCropBox();
        });

        // Mousemove event for dragging the crop box
        mainCanvas.addEventListener('mousemove', (e) => {
            if (!isDragging) return;

            const rect = mainCanvas.getBoundingClientRect();
            const scaleX = mainCanvas.width / rect.width;
            const scaleY = mainCanvas.height / rect.height;

            const currentX = (e.clientX - rect.left) * scaleX;
            const currentY = (e.clientY - rect.top) * scaleY;

            let newW = currentX - startX;
            let newH = currentY - startY;

            // Adjust height based on a fixed ratio
            if (cropRatio > 0) {
                newH = newW / cropRatio;
            }

            // Adjust crop box position and size to handle all drag directions
            if (newW < 0) {
                cropX = currentX;
                cropW = Math.abs(newW);
            } else {
                cropX = startX;
                cropW = newW;
            }

            if (newH < 0) {
                cropY = currentY;
                cropH = Math.abs(newH);
            } else {
                cropY = startY;
                cropH = newH;
            }
            
            // Ensure crop box stays within image bounds
            cropX = Math.max(0, cropX);
            cropY = Math.max(0, cropY);
            cropW = Math.min(mainCanvas.width - cropX, cropW);
            cropH = Math.min(mainCanvas.height - cropY, cropH);

            updateCropBox();
        });

        // Mouseup event for finalizing crop box selection
        mainCanvas.addEventListener('mouseup', () => {
            isDragging = false;
            // Save the final crop box position and size
            if (currentImageIndex !== -1) {
                allImages[currentImageIndex].crop = {
                    x: cropX,
                    y: cropY,
                    w: cropW,
                    h: cropH
                };
            }
        });

        // Update the visual display of the crop box
        function updateCropBox() {
            if (cropW > 0 && cropH > 0 && currentImageIndex !== -1) {
                cropBox.style.display = 'block';
                // Calculate position and size based on the scaled canvas
                const rect = mainCanvas.getBoundingClientRect();
                const scaleX = rect.width / mainCanvas.width;
                const scaleY = rect.height / mainCanvas.height;
                
                cropBox.style.left = `${cropX * scaleX}px`;
                cropBox.style.top = `${cropY * scaleY}px`;
                cropBox.style.width = `${cropW * scaleX}px`;
                cropBox.style.height = `${cropH * scaleY}px`;
            } else {
                cropBox.style.display = 'none';
            }
        }

        // Pre-defined ratio buttons click handler
        ratioButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                ratioButtons.forEach(b => {
                    b.classList.remove('bg-primary/20', 'text-primary');
                    b.classList.add('bg-light', 'text-text-color');
                });
                
                btn.classList.remove('bg-light', 'text-text-color');
                btn.classList.add('bg-primary/20', 'text-primary');
                
                const ratioValue = btn.dataset.ratio;
                if (ratioValue === '0') {
                    cropRatio = 0;
                    showNotification('已切换到自由裁剪模式');
                } else {
                    const [w, h] = ratioValue.split('/').map(Number);
                    cropRatio = w / h;
                    showNotification(`已设置裁剪比例为 ${w}:${h}`);
                }
                
                // Adjust crop box size based on the new ratio
                if (currentImageIndex !== -1 && cropW > 0 && cropH > 0) {
                    let newH = cropW / cropRatio;
                    if (cropY + newH > mainCanvas.height) {
                        newH = mainCanvas.height - cropY;
                        cropW = newH * cropRatio;
                    }
                    cropH = newH;
                    updateCropBox();
                }
            });
        });

        // Custom ratio button click handler
        setRatioButton.addEventListener('click', () => {
            const w = Number(customRatioW.value);
            const h = Number(customRatioH.value);
            if (w > 0 && h > 0) {
                cropRatio = w / h;
                
                ratioButtons.forEach(b => {
                    b.classList.remove('bg-primary/20', 'text-primary');
                    b.classList.add('bg-light', 'text-text-color');
                });
                
                showNotification(`已设置自定义裁剪比例为 ${w}:${h}`);
                
                if (currentImageIndex !== -1 && cropW > 0 && cropH > 0) {
                    let newH = cropW / cropRatio;
                    if (cropY + newH > mainCanvas.height) {
                        newH = mainCanvas.height - cropY;
                        cropW = newH * cropRatio;
                    }
                    cropH = newH;
                    updateCropBox();
                }
            } else {
                showNotification('请输入有效的宽高值！');
            }
        });

        // Crop the current image and add to download list
        cropButton.addEventListener('click', () => {
            if (currentImageIndex === -1) {
                showNotification('请先上传并选择图片！');
                return;
            }
            if (cropW === 0 || cropH === 0) {
                showNotification('请先选择裁剪区域！');
                return;
            }

            const currentImage = allImages[currentImageIndex];
            const croppedCanvas = document.createElement('canvas');
            const croppedCtx = croppedCanvas.getContext('2d');
            const crop = currentImage.crop;

            // Set the size of the cropped canvas
            croppedCanvas.width = crop.w;
            croppedCanvas.height = crop.h;

            // Crop and draw the image
            croppedCtx.drawImage(
                currentImage.original,
                crop.x,
                crop.y,
                crop.w,
                crop.h,
                0,
                0,
                crop.w,
                crop.h
            );

            const croppedDataUrl = croppedCanvas.toDataURL('image/png');
            displayCroppedImage(croppedDataUrl, currentImage.name);
            showNotification('图片裁剪成功！');
        });

        // 新增：裁剪全部图片功能
        cropAllButton.addEventListener('click', () => {
            if (allImages.length === 0) {
                showNotification('请先上传图片！');
                return;
            }
            
            if (cropW === 0 || cropH === 0) {
                showNotification('请先选择裁剪区域！');
                return;
            }
            
            // 使用当前的裁剪比例对所有图片进行裁剪
            const currentCropRatio = cropW / cropH;
            
            allImages.forEach((image, index) => {
                // 为每张张图片计算适合的裁剪区域
                const img = image.original;
                let cropW, cropH;
                
                // 根据当前裁剪裁剪比例和图片尺寸计算裁剪区域
                if (img.width / img.height > currentCropRatio) {
                    // 图片更宽，按高度计算
                    cropH = img.height;
                    cropW = cropH * currentCropRatio;
                } else {
                    // 图片更高，按宽度计算
                    cropW = img.width;
                    cropH = cropW / currentCropRatio;
                }
                
                // 居中裁剪
                const cropX = (img.width - cropW) / 2;
                const cropY = (img.height - cropH) / 2;
                
                // 保存裁剪信息
                image.crop = {x: cropX, y: cropY, w: cropW, h: cropH};
                
                // 执行裁剪并显示结果
                const croppedCanvas = document.createElement('canvas');
                const croppedCtx = croppedCanvas.getContext('2d');
                
                croppedCanvas.width = cropW;
                croppedCanvas.height = cropH;
                
                croppedCtx.drawImage(
                    img,
                    cropX,
                    cropY,
                    cropW,
                    cropH,
                    0,
                    0,
                    cropW,
                    cropH
                );
                
                const croppedDataUrl = croppedCanvas.toDataURL('image/png');
                displayCroppedImage(croppedDataUrl, image.name);
            });
            
            showNotification(`已完成所有 ${allImages.length} 张图片的裁剪！`);
        });

        // Display a cropped image in the download area
        function displayCroppedImage(dataUrl, originalName) {
            downloadContainer.classList.remove('hidden');
            
            const downloadItem = document.createElement('div');
            downloadItem.className = 'flex flex-col items-center gap-2';
            
            const img = document.createElement('img');
            img.src = dataUrl;
            img.className = 'w-24 h-24 object-cover rounded-lg shadow-md border border-border-color';
            
            const downloadLink = document.createElement('a');
            downloadLink.href = dataUrl;
            downloadLink.download = `cropped_${originalName}`;
            downloadLink.className = 'btn btn-primary text-xs px-2 py-1 flex items-center gap-1';
            downloadLink.innerHTML = '<i class="fa fa-download"></i> 下载';

            downloadItem.appendChild(img);
            downloadItem.appendChild(downloadLink);
            downloadList.appendChild(downloadItem);
        }

        // Batch download all cropped images
        downloadAllButton.addEventListener('click', () => {
            const links = downloadList.querySelectorAll('a');
            if (links.length === 0) {
                showNotification('没有可下载的图片！');
                return;
            }
            
            showNotification(`正在下载 ${links.length} 张图片`);
            
            links.forEach((link, index) => {
                setTimeout(() => link.click(), index * 300);
            });
        });
        
        // Clear all uploaded images and cropped results
        clearAllButton.addEventListener('click', () => {
            if (allImages.length === 0 && downloadList.children.length === 0) {
                showNotification('没有可清空的内容');
                return;
            }
            
            allImages = [];
            currentImageIndex = -1;
            thumbnailsContainer.innerHTML = '';
            downloadList.innerHTML = '';
            downloadContainer.classList.add('hidden');
            mainCanvas.classList.add('hidden');
            previewPlaceholder.classList.remove('hidden');
            noImagesPlaceholder.classList.remove('hidden');
            
            showNotification('已清空所有内容');
        });

        // 新增：返回主页按钮事件
        homeButton.addEventListener('click', () => {
            // 这里假设主页是根目录，实际应用中请修改为实际的主页URL
            window.location.href = '../index.html';
        });

        // Event listeners
        themeToggle.addEventListener('click', toggleTheme);
        
        // Initialize
        initTheme();
    </script>
</body>
</html>