<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>图片批量裁剪工具</title>
  <!-- 引入Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- Tailwind配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36CFC9',
            neutral: '#F5F7FA',
            dark: '#1D2129',
            success: '#52C41A',
            danger: '#FF4D4F',
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <!-- 自定义工具类 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .crop-handle {
        @apply w-3 h-3 bg-primary border-2 border-white rounded-full absolute transform -translate-x-1/2 -translate-y-1/2 shadow shadow-md z-10;
      }
      .crop-overlay {
        @apply absolute inset-0 bg-black/50 pointer-events-none;
      }
      .crop-box {
        @apply absolute border-2 border-primary bg-transparent cursor-move z-5;
      }
      .image-container {
        @apply relative bg-neutral rounded-lg overflow-hidden flex items-center justify-center min-h-[300px];
      }
      .btn-primary {
        @apply bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200
        transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2;
      }
      .btn-secondary {
        @apply bg-white border border-gray-300 hover:bg-gray-50 text-dark font-medium py-2 px-4 rounded-lg transition-all
        duration-200 transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2;
      }
      .btn-danger {
        @apply bg-danger hover:bg-danger/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200
        transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2;
      }
      .card {
        @apply bg-white rounded-xl shadow-sm border border-gray-100 p-5 transition-all duration-300 hover:shadow-md;
      }
      .progress-bar {
        @apply h-2 bg-gray-200 rounded-full overflow-hidden;
      }
      .progress-value {
        @apply h-full bg-primary transition-all duration-300 w-0;
      }
      /* 完善暗色模式样式 */
      .dark-mode .card,
      .dark-mode .btn-secondary {
        @apply bg-gray-800 border-gray-700 text-white;
      }
      .dark-mode .btn-secondary {
        @apply hover:bg-gray-700;
      }
      .dark-mode .crop-overlay {
        @apply bg-black/70;
      }
      .dark-mode .image-container,
      .dark-mode #dropArea,
      .dark-mode .bg-neutral {
        @apply bg-gray-800;
      }
      .dark-mode .text-gray-500,
      .dark-mode .text-gray-600 {
        @apply text-gray-400;
      }
    }
  </style>
</head>
<body class="font-inter bg-gray-50 text-dark min-h-screen flex flex-col">
  <!-- 顶部导航栏 -->
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center gap-2">
        <i class="fa fa-crop text-primary text-2xl"></i>
        <h1 class="text-xl font-bold text-dark">图片批量裁剪工具</h1>
      </div>
      <div class="flex items-center gap-3">
        <button id="helpBtn" class="btn-secondary text-sm">
          <i class="fa fa-question-circle"></i>
          <span>帮助</span>
        </button>
        <button id="themeToggle" class="btn-secondary text-sm">
          <i class="fa fa-moon-o"></i>
          <span>切换主题</span>
        </button>
      </div>
    </div>
  </header>

  <!-- 主要内容区 - 优化了容器和间距 -->
  <main class="flex-grow container mx-auto px-4 py-6 max-w-7xl">
    <!-- 上传区域 -->
    <section class="mb-8">
      <div class="card">
        <h2 class="text-lg font-semibold mb-4">上传图片</h2>
        <div id="dropArea" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-primary transition-colors duration-300 cursor-pointer">
          <i class="fa fa-cloud-upload text-4xl text-gray-400 mb-3"></i>
          <p class="mb-2 text-gray-600">拖放图片到此处，或点击选择图片</p>
          <p class="text-sm text-gray-500">支持 JPG、PNG、WEBP 格式，最多同时上传 10 张</p>
          <input type="file" id="fileInput" class="hidden" accept="image/*" multiple>
          <button id="browseBtn" class="mt-4 btn-primary">
            <i class="fa fa-file-image-o"></i>
            <span>选择图片</span>
          </button>
        </div>
        
        <!-- 上传队列 -->
        <div id="uploadQueue" class="mt-6 hidden">
          <h3 class="font-medium mb-3">上传队列</h3>
          <div id="queueItems" class="space-y-3 max-h-40 overflow-y-auto pr-2"></div>
          <div class="mt-4 flex justify-end gap-3">
            <button id="clearQueueBtn" class="btn-secondary">
              <i class="fa fa-trash-o"></i>
              <span>清空队列</span>
            </button>
            <button id="processQueueBtn" class="btn-primary">
              <i class="fa fa-cog"></i>
              <span>开始处理</span>
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- 处理区域 - 优化了响应式布局 -->
    <section id="processingSection" class="mb-8 hidden">
      <div class="card">
        <div class="flex flex-col lg:flex-row gap-6">
          <!-- 左侧：裁剪设置 - 调整了宽度比例和响应式行为 -->
          <div class="w-full lg:w-1/4">
            <h2 class="text-lg font-semibold mb-4">裁剪设置</h2>
            
            <!-- 比例选择 -->
            <div class="mb-6">
              <h3 class="font-medium mb-3">常用比例</h3>
              <div class="grid grid-cols-4 gap-2">
                <button class="aspect-square bg-neutral hover:bg-primary/10 rounded-md p-2 flex items-center justify-center transition-colors duration-200 ratio-btn" data-ratio="1:1">1:1</button>
                <button class="aspect-square bg-neutral hover:bg-primary/10 rounded-md p-2 flex items-center justify-center transition-colors duration-200 ratio-btn" data-ratio="4:3">4:3</button>
                <button class="aspect-square bg-neutral hover:bg-primary/10 rounded-md p-2 flex items-center justify-center transition-colors duration-200 ratio-btn" data-ratio="16:9">16:9</button>
                <button class="aspect-square bg-neutral hover:bg-primary/10 rounded-md p-2 flex items-center justify-center transition-colors duration-200 ratio-btn" data-ratio="3:2">3:2</button>
                <button class="aspect-square bg-neutral hover:bg-primary/10 rounded-md p-2 flex items-center justify-center transition-colors duration-200 ratio-btn" data-ratio="2:3">2:3</button>
                <button class="aspect-square bg-neutral hover:bg-primary/10 rounded-md p-2 flex items-center justify-center transition-colors duration-200 ratio-btn" data-ratio="9:16">9:16</button>
                <button class="aspect-square bg-neutral hover:bg-primary/10 rounded-md p-2 flex items-center justify-center transition-colors duration-200 ratio-btn" data-ratio="5:4">5:4</button>
                <button class="aspect-square bg-neutral hover:bg-primary/10 rounded-md p-2 flex items-center justify-center transition-colors duration-200 ratio-btn" data-ratio="custom">自定义</button>
              </div>
              
              <!-- 自定义比例 -->
              <div id="customRatio" class="mt-4 hidden">
                <div class="flex items-center gap-2">
                  <input type="number" id="widthRatio" class="w-20 p-2 border border-gray-300 rounded-md" placeholder="宽">
                  <span class="text-gray-500">:</span>
                  <input type="number" id="heightRatio" class="w-20 p-2 border border-gray-300 rounded-md" placeholder="高">
                  <button id="applyCustomRatio" class="btn-primary text-sm px-3">应用</button>
                </div>
              </div>
            </div>
            
            <!-- 当前图片信息 -->
            <div class="mb-6 p-3 bg-neutral rounded-lg">
              <h3 class="font-medium mb-3">图片信息</h3>
              <div class="space-y-2 text-sm">
                <p><span class="text-gray-500">文件名：</span><span id="currentFileName">-</span></p>
                <p><span class="text-gray-500">尺寸：</span><span id="currentImageSize">-</span></p>
                <p><span class="text-gray-500">当前比例：</span><span id="currentRatio">-</span></p>
              </div>
            </div>
            
            <!-- 操作按钮 -->
            <div class="flex flex-col gap-3">
              <button id="cropBtn" class="btn-primary w-full">
                <i class="fa fa-scissors"></i>
                <span>裁剪图片</span>
              </button>
              <button id="resetCropBtn" class="btn-secondary w-full">
                <i class="fa fa-refresh"></i>
                <span>重置</span>
              </button>
            </div>
            
            <!-- 批量操作 -->
            <div class="mt-6 pt-4 border-t border-gray-100">
              <h3 class="font-medium mb-3">批量操作</h3>
              <div class="space-y-3">
                <button id="applyToAllBtn" class="btn-secondary w-full">
                  <i class="fa fa-clone"></i>
                  <span>应用当前设置到全部</span>
                </button>
                <button id="cropAllBtn" class="btn-primary w-full">
                  <i class="fa fa-crop"></i>
                  <span>批量裁剪</span>
                </button>
              </div>
            </div>
          </div>
          
          <!-- 右侧：预览和裁剪区域 - 调整了宽度比例 -->
          <div class="w-full lg:w-3/4">
            <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
              <h2 class="text-lg font-semibold">裁剪预览</h2>
              <div class="flex items-center gap-2">
                <span class="text-sm text-gray-500">图片</span>
                <span id="imageCounter">1/0</span>
                <button id="prevImageBtn" class="btn-secondary text-sm px-2 py-1 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                  <i class="fa fa-chevron-left"></i>
                </button>
                <button id="nextImageBtn" class="btn-secondary text-sm px-2 py-1 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                  <i class="fa fa-chevron-right"></i>
                </button>
              </div>
            </div>
            
            <!-- 裁剪区域 -->
            <div class="image-container relative mb-6" id="cropContainer">
              <div id="imagePreview" class="max-w-full max-h-[400px] relative">
                <!-- 图片和裁剪框将在这里动态生成 -->
                <div class="text-gray-500 flex flex-col items-center justify-center py-10">
                  <i class="fa fa-picture-o text-4xl mb-3"></i>
                  <p>请上传图片进行裁剪</p>
                </div>
              </div>
            </div>
            
            <!-- 裁剪后预览 -->
            <div>
              <h3 class="font-medium mb-3">裁剪后预览</h3>
              <div class="image-container" id="croppedPreview">
                <div class="text-gray-500 flex flex-col items-center justify-center py-10">
                  <i class="fa fa-eye text-4xl mb-3"></i>
                  <p>裁剪后的图片将在这里显示</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 结果区域 - 优化了网格布局 -->
    <section id="resultsSection" class="mb-8 hidden">
      <div class="card">
        <div class="flex flex-wrap justify-between items-center mb-6 gap-2">
          <h2 class="text-lg font-semibold">处理结果</h2>
          <button id="downloadAllBtn" class="btn-primary">
            <i class="fa fa-download"></i>
            <span>下载全部</span>
          </button>
        </div>
        
        <div id="resultsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
          <!-- 结果将在这里动态生成 -->
        </div>
      </div>
    </section>
  </main>

  <!-- 底部信息 -->
  <footer class="bg-white border-t border-gray-200 py-4 mt-auto">
    <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
      <p>图片裁剪工具 v20250803 | 安全离线处理，图片不会上传到服务器</p>
    </div>
  </footer>

  <!-- 帮助模态框 - 优化了样式和位置 -->
  <div id="helpModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-xl max-w-md w-full max-h-[80vh] overflow-y-auto p-6 m-4 shadow-lg">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">使用帮助</h3>
        <button id="closeHelpBtn" class="text-gray-500 hover:text-dark transition-colors">
          <i class="fa fa-times text-xl"></i>
        </button>
      </div>
      <div class="space-y-4 text-gray-700">
        <div>
          <h4 class="font-semibold mb-2">1. 上传图片</h4>
          <p>点击"选择图片"按钮或直接将图片拖放到上传区域，可以同时上传多张图片。</p>
        </div>
        <div>
          <h4 class="font-semibold mb-2">2. 选择裁剪比例</h4>
          <p>可以从常用比例中选择，也可以点击"自定义"设置特定比例。</p>
        </div>
        <div>
          <h4 class="font-semibold mb-2">3. 调整裁剪区域</h4>
          <p>拖动裁剪框可以移动位置，拖动边缘或角落可以调整大小（保持比例）。</p>
        </div>
        <div>
          <h4 class="font-semibold mb-2">4. 处理图片</h4>
          <p>可以单张裁剪，也可以应用相同设置批量裁剪所有图片。</p>
        </div>
        <div>
          <h4 class="font-semibold mb-2">5. 下载图片</h4>
          <p>处理完成后，可以单张下载或一次性下载所有裁剪后的图片。</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 全局变量
    let images = [];          // 存储所有上传的图片信息
    let currentImageIndex = 0;// 当前正在处理的图片索引
    let currentRatio = '1:1'; // 当前选择的比例
    let cropData = {};        // 存储每张图片的裁剪数据
    let isDragging = false;   // 是否正在拖动裁剪框
    let dragHandle = null;    // 当前拖动的手柄
    let startX, startY;       // 拖动开始时的坐标
    let startCropX, startCropY, startCropWidth, startCropHeight; // 裁剪框初始状态

    // DOM元素
    const dropArea = document.getElementById('dropArea');
    const fileInput = document.getElementById('fileInput');
    const browseBtn = document.getElementById('browseBtn');
    const uploadQueue = document.getElementById('uploadQueue');
    const queueItems = document.getElementById('queueItems');
    const clearQueueBtn = document.getElementById('clearQueueBtn');
    const processQueueBtn = document.getElementById('processQueueBtn');
    const processingSection = document.getElementById('processingSection');
    const resultsSection = document.getElementById('resultsSection');
    const resultsGrid = document.getElementById('resultsGrid');
    const ratioBtns = document.querySelectorAll('.ratio-btn');
    const customRatio = document.getElementById('customRatio');
    const widthRatio = document.getElementById('widthRatio');
    const heightRatio = document.getElementById('heightRatio');
    const applyCustomRatio = document.getElementById('applyCustomRatio');
    const currentFileName = document.getElementById('currentFileName');
    const currentImageSize = document.getElementById('currentImageSize');
    const currentRatioEl = document.getElementById('currentRatio');
    const cropBtn = document.getElementById('cropBtn');
    const resetCropBtn = document.getElementById('resetCropBtn');
    const applyToAllBtn = document.getElementById('applyToAllBtn');
    const cropAllBtn = document.getElementById('cropAllBtn');
    const imageCounter = document.getElementById('imageCounter');
    const prevImageBtn = document.getElementById('prevImageBtn');
    const nextImageBtn = document.getElementById('nextImageBtn');
    const imagePreview = document.getElementById('imagePreview');
    const croppedPreview = document.getElementById('croppedPreview');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const helpBtn = document.getElementById('helpBtn');
    const helpModal = document.getElementById('helpModal');
    const closeHelpBtn = document.getElementById('closeHelpBtn');
    const themeToggle = document.getElementById('themeToggle');

    // 初始化事件监听
    function initEventListeners() {
      // 上传相关
      browseBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', handleFileSelect);
      dropArea.addEventListener('dragover', handleDragOver);
      dropArea.addEventListener('dragleave', handleDragLeave);
      dropArea.addEventListener('drop', handleDrop);
      clearQueueBtn.addEventListener('click', clearQueue);
      processQueueBtn.addEventListener('click', processQueue);
      
      // 比例选择
      ratioBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          ratioBtns.forEach(b => b.classList.remove('bg-primary/20', 'font-medium'));
          btn.classList.add('bg-primary/20', 'font-medium');
          
          if (btn.dataset.ratio === 'custom') {
            customRatio.classList.remove('hidden');
            currentRatio = 'custom';
          } else {
            customRatio.classList.add('hidden');
            currentRatio = btn.dataset.ratio;
            updateCropBox();
          }
          updateCurrentRatioDisplay();
        });
      });
      
      applyCustomRatio.addEventListener('click', applyCustomRatioHandler);
      
      // 图片导航
      prevImageBtn.addEventListener('click', showPrevImage);
      nextImageBtn.addEventListener('click', showNextImage);
      
      // 裁剪操作
      cropBtn.addEventListener('click', cropCurrentImage);
      resetCropBtn.addEventListener('click', resetCrop);
      applyToAllBtn.addEventListener('click', applyCurrentSettingsToAll);
      cropAllBtn.addEventListener('click', cropAllImages);
      
      // 下载
      downloadAllBtn.addEventListener('click', downloadAllImages);
      
      // 帮助模态框
      helpBtn.addEventListener('click', () => helpModal.classList.remove('hidden'));
      closeHelpBtn.addEventListener('click', () => helpModal.classList.add('hidden'));
      helpModal.addEventListener('click', (e) => {
        if (e.target === helpModal) helpModal.classList.add('hidden');
      });
      
      // 主题切换
      themeToggle.addEventListener('click', toggleTheme);
    }

    // 处理文件选择
    function handleFileSelect(e) {
      const files = e.target.files;
      if (files.length > 0) {
        addFilesToQueue(files);
      }
    }

    // 处理拖放事件
    function handleDragOver(e) {
      e.preventDefault();
      dropArea.classList.add('border-primary', 'bg-primary/5');
    }

    function handleDragLeave() {
      dropArea.classList.remove('border-primary', 'bg-primary/5');
    }

    function handleDrop(e) {
      e.preventDefault();
      dropArea.classList.remove('border-primary', 'bg-primary/5');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        addFilesToQueue(files);
      }
    }

    // 添加文件到队列
    function addFilesToQueue(files) {
      // 过滤非图片文件
      const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
      
      if (imageFiles.length === 0) {
        alert('请选择图片文件（JPG、PNG、WEBP等）');
        return;
      }
      
      // 限制最多10张图片
      const maxFiles = 10;
      const currentCount = queueItems.children.length;
      const canAdd = Math.min(maxFiles - currentCount, imageFiles.length);
      
      if (canAdd < imageFiles.length) {
        alert(`最多只能上传${maxFiles}张图片，已为您添加${canAdd}张`);
      }
      
      // 显示队列区域
      uploadQueue.classList.remove('hidden');
      
      // 添加到队列
      for (let i = 0; i < canAdd; i++) {
        const file = imageFiles[i];
        addFileToQueueUI(file);
      }
    }

    // 添加文件到队列UI
    function addFileToQueueUI(file) {
      const reader = new FileReader();
      
      reader.onload = function(e) {
        const queueItem = document.createElement('div');
        queueItem.className = 'flex items-center gap-3 p-2 bg-neutral rounded-lg';
        queueItem.dataset.fileName = file.name;
        
        // 生成缩略图
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const maxWidth = 50;
          const maxHeight = 50;
          let width = img.width;
          let height = img.height;
          
          // 计算缩略图尺寸
          if (width > height) {
            if (width > maxWidth) {
              height = height * (maxWidth / width);
              width = maxWidth;
            }
          } else {
            if (height > maxHeight) {
              width = width * (maxHeight / height);
              height = maxHeight;
            }
          }
          
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          
          queueItem.innerHTML = `
            <div class="w-12 h-12 bg-white rounded overflow-hidden flex items-center justify-center">
              <img src="${canvas.toDataURL()}" alt="${file.name}" class="max-w-full max-h-full">
            </div>
            <div class="flex-grow min-w-0">
              <p class="text-sm font-medium truncate">${file.name}</p>
              <p class="text-xs text-gray-500">${(file.size / 1024).toFixed(1)} KB</p>
            </div>
            <button class="remove-queue-item text-gray-400 hover:text-danger transition-colors">
              <i class="fa fa-times"></i>
            </button>
          `;
          
          // 添加删除事件
          queueItem.querySelector('.remove-queue-item').addEventListener('click', () => {
            queueItem.remove();
            if (queueItems.children.length === 0) {
              uploadQueue.classList.add('hidden');
            }
          });
          
          queueItems.appendChild(queueItem);
        };
        
        img.src = e.target.result;
      };
      
      reader.readAsDataURL(file);
    }

    // 清空队列
    function clearQueue() {
      if (confirm('确定要清空所有上传的图片吗？')) {
        queueItems.innerHTML = '';
        uploadQueue.classList.add('hidden');
      }
    }

    // 处理队列，开始处理图片
    function processQueue() {
      const queueItems = document.querySelectorAll('#queueItems > div');
      
      if (queueItems.length === 0) {
        alert('请先上传图片');
        return;
      }
      
      // 重置图片数据
      images = [];
      currentImageIndex = 0;
      cropData = {};
      
      // 处理每张图片
      const files = Array.from(fileInput.files);
      
      queueItems.forEach((item, index) => {
        const fileName = item.dataset.fileName;
        // 修复文件查找逻辑，确保正确匹配文件
        const file = files.find(f => f.name === fileName);
        
        if (file) {
          const reader = new FileReader();
          
          reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
              images.push({
                name: file.name,
                src: e.target.result,
                width: img.width,
                height: img.height,
                file: file
              });
              
              // 初始化裁剪数据
              cropData[images.length - 1] = {
                ratio: currentRatio,
                x: 0,
                y: 0,
                width: 0,
                height: 0
              };
              
              // 当所有图片都加载完成后，显示第一张
              if (images.length === queueItems.length) {
                showProcessingSection();
                showImage(currentImageIndex);
                updateImageCounter();
                updateNavigationButtons();
              }
            };
            
            img.src = e.target.result;
          };
          
          reader.readAsDataURL(file);
        }
      });
    }

    // 显示处理区域
    function showProcessingSection() {
      processingSection.classList.remove('hidden');
      resultsSection.classList.add('hidden');
      uploadQueue.classList.add('hidden');
    }

    // 显示结果区域
    function showResultsSection() {
      resultsSection.classList.remove('hidden');
      processingSection.classList.add('hidden');
      renderResults();
    }

    // 显示指定索引的图片
    function showImage(index) {
      if (index < 0 || index >= images.length) return;
      
      currentImageIndex = index;
      const image = images[index];
      
      // 更新图片信息
      currentFileName.textContent = image.name;
      currentImageSize.textContent = `${image.width} × ${image.height}`;
      
      // 更新当前比例
      currentRatio = cropData[index].ratio || '1:1';
      updateCurrentRatioDisplay();
      
      // 高亮选中的比例按钮
      ratioBtns.forEach(btn => {
        if (btn.dataset.ratio === currentRatio) {
          btn.classList.add('bg-primary/20', 'font-medium');
        } else {
          btn.classList.remove('bg-primary/20', 'font-medium');
        }
      });
      
      // 显示或隐藏自定义比例
      if (currentRatio === 'custom') {
        customRatio.classList.remove('hidden');
      } else {
        customRatio.classList.add('hidden');
      }
      
      // 渲染图片和裁剪框
      renderImageWithCropBox(image);
      
      // 重置裁剪后预览
      croppedPreview.innerHTML = `
        <div class="text-gray-500 flex flex-col items-center justify-center py-10">
          <i class="fa fa-eye text-4xl mb-3"></i>
          <p>裁剪后的图片将在这里显示</p>
        </div>
      `;
    }

    // 更新当前比例显示
    function updateCurrentRatioDisplay() {
      currentRatioEl.textContent = currentRatio;
    }

    // 渲染图片和裁剪框
    function renderImageWithCropBox(image) {
      // 清空预览区域
      imagePreview.innerHTML = '';
      
      // 创建图片容器
      const container = document.createElement('div');
      container.className = 'relative';
      container.style.maxWidth = '100%';
      container.style.maxHeight = '400px';
      
      // 创建图片元素
      const img = document.createElement('img');
      img.src = image.src;
      img.alt = image.name;
      img.className = 'max-w-full max-h-[400px]';
      img.id = 'previewImage';
      
      container.appendChild(img);
      
      // 等待图片加载完成后创建裁剪框
      img.onload = function() {
        createCropBox(image, container);
      };
      
      imagePreview.appendChild(container);
    }

    // 创建裁剪框
    function createCropBox(image, container) {
      const img = document.getElementById('previewImage');
      const imgWidth = img.offsetWidth;
      const imgHeight = img.offsetHeight;
      const originalWidth = image.width;
      const originalHeight = image.height;
      
      // 计算缩放比例
      const scale = imgWidth / originalWidth;
      
      // 获取或计算裁剪区域
      let crop = cropData[currentImageIndex];
      
      if (!crop || !crop.width || !crop.height) {
        // 计算初始裁剪区域
        const [wRatio, hRatio] = currentRatio.split(':').map(Number);
        let cropWidth, cropHeight;
        
        // 计算符合比例的最大裁剪区域
        if (imgWidth / imgHeight > wRatio / hRatio) {
          // 图片更宽，以高度为基准
          cropHeight = imgHeight;
          cropWidth = (imgHeight * wRatio) / hRatio;
        } else {
          // 图片更高，以宽度为基准
          cropWidth = imgWidth;
          cropHeight = (imgWidth * hRatio) / wRatio;
        }
        
        // 确保裁剪区域不超过图片大小
        cropWidth = Math.min(cropWidth, imgWidth);
        cropHeight = Math.min(cropHeight, imgHeight);
        
        // 最小尺寸限制
        cropWidth = Math.max(50, cropWidth);
        cropHeight = Math.max(50, cropHeight);
        
        // 居中裁剪区域
        const cropX = (imgWidth - cropWidth) / 2;
        const cropY = (imgHeight - cropHeight) / 2;
        
        // 保存裁剪数据（原始尺寸）
        crop = {
          ratio: currentRatio,
          x: cropX / scale,
          y: cropY / scale,
          width: cropWidth / scale,
          height: cropHeight / scale
        };
        
        cropData[currentImageIndex] = crop;
      }
      
      // 创建遮罩层
      const overlay = document.createElement('div');
      overlay.className = 'crop-overlay';
      overlay.style.clipPath = `polygon(
        0 0, 0 100%, 
        ${crop.x * scale}px 100%, ${crop.x * scale}px ${crop.y * scale}px, 
        ${(crop.x + crop.width) * scale}px ${crop.y * scale}px, ${(crop.x + crop.width) * scale}px ${(crop.y + crop.height) * scale}px, 
        ${crop.x * scale}px ${(crop.y + crop.height) * scale}px, ${crop.x * scale}px 100%, 
        100% 100%, 100% 0
      )`;
      
      // 创建裁剪框
      const cropBox = document.createElement('div');
      cropBox.className = 'crop-box';
      cropBox.style.left = `${crop.x * scale}px`;
      cropBox.style.top = `${crop.y * scale}px`;
      cropBox.style.width = `${crop.width * scale}px`;
      cropBox.style.height = `${crop.height * scale}px`;
      
      // 创建拖动手柄
      const handles = [
        { className: 'top-0 left-0 cursor-nwse-resize', x: 0, y: 0 },
        { className: 'top-0 left-1/2 cursor-ns-resize', x: '50%', y: 0 },
        { className: 'top-0 right-0 cursor-nesw-resize', x: '100%', y: 0 },
        { className: 'top-1/2 left-0 cursor-ew-resize', x: 0, y: '50%' },
        { className: 'top-1/2 right-0 cursor-ew-resize', x: '100%', y: '50%' },
        { className: 'bottom-0 left-0 cursor-nesw-resize', x: 0, y: '100%' },
        { className: 'bottom-0 left-1/2 cursor-ns-resize', x: '50%', y: '100%' },
        { className: 'bottom-0 right-0 cursor-nwse-resize', x: '100%', y: '100%' }
      ];
      
      handles.forEach((handle, index) => {
        const div = document.createElement('div');
        div.className = `crop-handle ${handle.className}`;
        div.style.left = handle.x;
        div.style.top = handle.y;
        div.dataset.handle = index;
        cropBox.appendChild(div);
      });
      
      // 添加事件监听
      setupCropBoxEvents(cropBox, overlay, img, scale);
      
      container.appendChild(overlay);
      container.appendChild(cropBox);
    }

    // 设置裁剪框事件
    function setupCropBoxEvents(cropBox, overlay, img, scale) {
      const imgWidth = img.offsetWidth;
      const imgHeight = img.offsetHeight;
      const originalWidth = images[currentImageIndex].width;
      const originalHeight = images[currentImageIndex].height;
      
      // 裁剪框拖动
      cropBox.addEventListener('mousedown', (e) => {
        e.preventDefault();
        if (e.target === cropBox) {
          isDragging = true;
          dragHandle = null;
          startX = e.clientX;
          startY = e.clientY;
          startCropX = parseFloat(cropBox.style.left);
          startCropY = parseFloat(cropBox.style.top);
          
          document.body.style.cursor = 'move';
        }
      });
      
      // 手柄拖动
      document.querySelectorAll('.crop-handle').forEach(handle => {
        handle.addEventListener('mousedown', (e) => {
          e.preventDefault();
          e.stopPropagation();
          isDragging = true;
          dragHandle = handle.dataset.handle;
          startX = e.clientX;
          startY = e.clientY;
          startCropX = parseFloat(cropBox.style.left);
          startCropY = parseFloat(cropBox.style.top);
          startCropWidth = parseFloat(cropBox.style.width);
          startCropHeight = parseFloat(cropBox.style.height);
        });
      });
      
      // 鼠标移动
      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        
        e.preventDefault();
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        let newX = startCropX;
        let newY = startCropY;
        let newWidth = startCropWidth;
        let newHeight = startCropHeight;
        
        // 解析比例
        const ratioParts = currentRatio.split(':').map(Number);
        if (isNaN(ratioParts[0]) || isNaN(ratioParts[1]) || ratioParts[1] === 0) {
          console.error('无效的比例值:', currentRatio);
          return;
        }
        const ratio = ratioParts[0] / ratioParts[1];
        
        if (dragHandle === null) {
          // 移动整个裁剪框
          newX = startCropX + dx;
          newY = startCropY + dy;
          
          // 限制在图片范围内
          newX = Math.max(0, Math.min(newX, imgWidth - newWidth));
          newY = Math.max(0, Math.min(newY, imgHeight - newHeight));
        } else {
          // 调整裁剪框大小
          switch(dragHandle) {
            case '0': // 左上角
              newWidth = startCropWidth - dx;
              newHeight = newWidth / ratio;
              newX = startCropX + dx;
              newY = startCropY + (newHeight - startCropHeight);
              break;
            case '2': // 右上角
              newWidth = startCropWidth + dx;
              newHeight = newWidth / ratio;
              newY = startCropY + (newHeight - startCropHeight);
              break;
            case '5': // 左下角
              newWidth = startCropWidth - dx;
              newHeight = newWidth / ratio;
              newX = startCropX + dx;
              break;
            case '7': // 右下角
              newWidth = startCropWidth + dx;
              newHeight = newWidth / ratio;
              break;
            case '1': // 上中
              newHeight = startCropHeight - dy;
              newWidth = newHeight * ratio;
              newY = startCropY + dy;
              break;
            case '6': // 下中
              newHeight = startCropHeight + dy;
              newWidth = newHeight * ratio;
              break;
            case '3': // 左中
              newWidth = startCropWidth - dx;
              newHeight = newWidth / ratio;
              newX = startCropX + dx;
              break;
            case '4': // 右中
              newWidth = startCropWidth + dx;
              newHeight = newWidth / ratio;
              break;
          }
          
          // 最小尺寸限制
          const minSize = 50;
          newWidth = Math.max(minSize, newWidth);
          newHeight = Math.max(minSize, newHeight);
          
          // 确保比例准确（防止浮点误差）
          newHeight = newWidth / ratio;
          
          // 限制在图片范围内
          if (newX < 0) {
            newX = 0;
            newWidth = imgWidth - newX;
            newHeight = newWidth / ratio;
          }
          
          if (newY < 0) {
            newY = 0;
            newHeight = imgHeight - newY;
            newWidth = newHeight * ratio;
          }
          
          if (newX + newWidth > imgWidth) {
            newWidth = imgWidth - newX;
            newHeight = newWidth / ratio;
          }
          
          if (newY + newHeight > imgHeight) {
            newHeight = imgHeight - newY;
            newWidth = newHeight * ratio;
          }
        }
        
        // 更新裁剪框位置和大小
        cropBox.style.left = `${newX}px`;
        cropBox.style.top = `${newY}px`;
        cropBox.style.width = `${newWidth}px`;
        cropBox.style.height = `${newHeight}px`;
        
        // 更新遮罩层
        overlay.style.clipPath = `polygon(
          0 0, 0 100%, 
          ${newX}px 100%, ${newX}px ${newY}px, 
          ${newX + newWidth}px ${newY}px, ${newX + newWidth}px ${newY + newHeight}px, 
          ${newX}px ${newY + newHeight}px, ${newX}px 100%, 
          100% 100%, 100% 0
        )`;
        
        // 保存裁剪数据（转换为原始尺寸）
        cropData[currentImageIndex] = {
          ratio: currentRatio,
          x: newX / scale,
          y: newY / scale,
          width: newWidth / scale,
          height: newHeight / scale
        };
      });
      
      // 鼠标释放
      document.addEventListener('mouseup', () => {
        if (isDragging) {
          isDragging = false;
          dragHandle = null;
          document.body.style.cursor = '';
        }
      });
      
      // 鼠标离开窗口
      document.addEventListener('mouseleave', () => {
        if (isDragging) {
          isDragging = false;
          dragHandle = null;
          document.body.style.cursor = '';
        }
      });
    }

    // 更新裁剪框（比例改变时）
    function updateCropBox() {
      const image = images[currentImageIndex];
      if (!image) return;
      
      renderImageWithCropBox(image);
    }

    // 应用自定义比例
    function applyCustomRatioHandler() {
      const width = parseInt(widthRatio.value);
      const height = parseInt(heightRatio.value);
      
      if (isNaN(width) || isNaN(height) || width <= 0 || height <= 0) {
        alert('请输入有效的宽高比例');
        return;
      }
      
      currentRatio = `${width}:${height}`;
      cropData[currentImageIndex].ratio = currentRatio;
      
      // 更新UI
      ratioBtns.forEach(btn => {
        btn.classList.remove('bg-primary/20', 'font-medium');
        if (btn.dataset.ratio === 'custom') {
          btn.classList.add('bg-primary/20', 'font-medium');
        }
      });
      
      updateCurrentRatioDisplay();
      updateCropBox();
    }

    // 更新图片计数器
    function updateImageCounter() {
      imageCounter.textContent = `${currentImageIndex + 1}/${images.length}`;
    }

    // 更新导航按钮状态
    function updateNavigationButtons() {
      prevImageBtn.disabled = currentImageIndex === 0;
      nextImageBtn.disabled = currentImageIndex === images.length - 1;
    }

    // 显示上一张图片
    function showPrevImage() {
      if (currentImageIndex > 0) {
        showImage(currentImageIndex - 1);
        updateImageCounter();
        updateNavigationButtons();
      }
    }

    // 显示下一张图片
    function showNextImage() {
      if (currentImageIndex < images.length - 1) {
        showImage(currentImageIndex + 1);
        updateImageCounter();
        updateNavigationButtons();
      }
    }

    // 裁剪当前图片
    function cropCurrentImage() {
      const image = images[currentImageIndex];
      const crop = cropData[currentImageIndex];
      
      if (!image || !crop) return;
      
      const img = new Image();
      img.crossOrigin = "anonymous";
      
      img.onload = function() {
        try {
          // 创建canvas进行裁剪
          const canvas = document.createElement('canvas');
          
          // 确保裁剪尺寸为整数
          const cropWidth = Math.round(crop.width);
          const cropHeight = Math.round(crop.height);
          const cropX = Math.round(crop.x);
          const cropY = Math.round(crop.y);
          
          // 验证裁剪参数有效性
          if (cropX < 0 || cropY < 0 || 
              cropWidth <= 0 || cropHeight <= 0 ||
              cropX + cropWidth > img.width || 
              cropY + cropHeight > img.height) {
            throw new Error('裁剪区域超出图片范围');
          }
          
          canvas.width = cropWidth;
          canvas.height = cropHeight;
          
          const ctx = canvas.getContext('2d');
          // 绘制裁剪区域
          ctx.drawImage(
            img,
            cropX, cropY, cropWidth, cropHeight,
            0, 0, cropWidth, cropHeight
          );
          
          // 保存裁剪结果
          image.croppedSrc = canvas.toDataURL('image/png');
          
          // 更新裁剪后预览
          croppedPreview.innerHTML = `
            <img src="${image.croppedSrc}" alt="裁剪后的 ${image.name}" class="max-w-full max-h-[200px]">
          `;
        } catch (error) {
          console.error('裁剪失败:', error);
          alert(`裁剪失败: ${error.message}`);
        }
      };
      
      img.onerror = function() {
        console.error('图片加载失败');
        alert('图片加载失败，无法进行裁剪');
      };
      
      img.src = image.src;
    }

    // 重置裁剪
    function resetCrop() {
      if (confirm('确定要重置当前图片的裁剪设置吗？')) {
        delete cropData[currentImageIndex];
        showImage(currentImageIndex);
      }
    }

    // 应用当前设置到所有图片
    function applyCurrentSettingsToAll() {
      if (images.length <= 1) return;
      
      if (confirm(`确定要将当前设置应用到所有 ${images.length} 张图片吗？`)) {
        const currentCrop = cropData[currentImageIndex];
        
        images.forEach((image, index) => {
          if (index !== currentImageIndex) {
            // 计算相对比例的裁剪区域
            const ratio = currentCrop.ratio;
            const [wRatio, hRatio] = ratio.split(':').map(Number);
            
            // 计算新的裁剪区域
            let cropWidth, cropHeight;
            
            if (image.width / image.height > wRatio / hRatio) {
              // 图片更宽，以高度为基准
              cropHeight = image.height;
              cropWidth = (image.height * wRatio) / hRatio;
            } else {
              // 图片更高，以宽度为基准
              cropWidth = image.width;
              cropHeight = (image.width * hRatio) / wRatio;
            }
            
            // 确保裁剪区域不超过图片大小
            cropWidth = Math.min(cropWidth, image.width);
            cropHeight = Math.min(cropHeight, image.height);
            
            // 最小尺寸限制
            cropWidth = Math.max(50, cropWidth);
            cropHeight = Math.max(50, cropHeight);
            
            // 居中裁剪区域
            const cropX = (image.width - cropWidth) / 2;
            const cropY = (image.height - cropHeight) / 2;
            
            // 应用设置
            cropData[index] = {
              ratio: ratio,
              x: cropX,
              y: cropY,
              width: cropWidth,
              height: cropHeight
            };
          }
        });
        
        // 显示成功提示
        alert('已将当前设置应用到所有图片');
      }
    }

    // 批量裁剪所有图片
    function cropAllImages() {
      if (images.length === 0) return;
      
      // 显示进度
      imagePreview.innerHTML = `
        <div class="text-center py-10">
          <div class="inline-block animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-primary mb-4"></div>
          <p class="text-gray-600">正在批量裁剪图片...</p>
          <div class="progress-bar mt-4 w-full">
            <div id="batchProgress" class="progress-value"></div>
          </div>
        </div>
      `;
      
      let completed = 0;
      let errors = 0;
      
      // 逐个裁剪图片
      images.forEach((image, index) => {
        const crop = cropData[index];
        
        if (!crop) {
          completed++;
          errors++;
          document.getElementById('batchProgress').style.width = `${(completed / images.length) * 100}%`;
          return;
        }
        
        const img = new Image();
        img.crossOrigin = "anonymous";
        
        img.onload = function() {
          try {
            // 创建canvas进行裁剪
            const canvas = document.createElement('canvas');
            
            // 确保裁剪尺寸为整数
            const cropWidth = Math.round(crop.width);
            const cropHeight = Math.round(crop.height);
            const cropX = Math.round(crop.x);
            const cropY = Math.round(crop.y);
            
            // 验证裁剪参数有效性
            if (cropX < 0 || cropY < 0 || 
                cropWidth <= 0 || cropHeight <= 0 ||
                cropX + cropWidth > img.width || 
                cropY + cropHeight > img.height) {
              throw new Error('裁剪区域超出图片范围');
            }
            
            canvas.width = cropWidth;
            canvas.height = cropHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(
              img,
              cropX, cropY, cropWidth, cropHeight,
              0, 0, cropWidth, cropHeight
            );
            
            // 保存裁剪结果
            image.croppedSrc = canvas.toDataURL('image/png');
          } catch (error) {
            console.error(`裁剪图片 ${image.name} 失败:`, error);
            errors++;
          } finally {
            // 更新进度
            completed++;
            document.getElementById('batchProgress').style.width = `${(completed / images.length) * 100}%`;
            
            // 全部完成后显示结果
            if (completed === images.length) {
              setTimeout(() => {
                showResultsSection();
                if (errors > 0) {
                  alert(`批量裁剪完成，其中 ${errors} 张图片处理失败`);
                }
              }, 500);
            }
          }
        };
        
        img.onerror = function() {
          console.error(`图片 ${image.name} 加载失败`);
          errors++;
          completed++;
          document.getElementById('batchProgress').style.width = `${(completed / images.length) * 100}%`;
          
          if (completed === images.length) {
            setTimeout(() => {
              showResultsSection();
              alert(`批量裁剪完成，其中 ${errors} 张图片处理失败`);
            }, 500);
          }
        };
        
        img.src = image.src;
      });
    }

    // 渲染结果
    function renderResults() {
      resultsGrid.innerHTML = '';
      
      images.forEach((image, index) => {
        if (!image.croppedSrc) {
          // 显示处理失败的图片
          const resultItem = document.createElement('div');
          resultItem.className = 'bg-white rounded-lg overflow-hidden border border-gray-100 shadow-sm';
          
          resultItem.innerHTML = `
            <div class="aspect-video bg-neutral flex items-center justify-center">
              <i class="fa fa-exclamation-triangle text-danger text-4xl"></i>
            </div>
            <div class="p-3">
              <p class="text-sm font-medium truncate">${image.name}</p>
              <p class="text-xs text-danger mb-2">处理失败</p>
              <button class="retry-btn btn-secondary w-full text-sm py-1" data-index="${index}">
                <i class="fa fa-refresh"></i>
                <span>重试</span>
              </button>
            </div>
          `;
          
          resultItem.querySelector('.retry-btn').addEventListener('click', (e) => {
            const idx = parseInt(e.currentTarget.dataset.index);
            showProcessingSection();
            showImage(idx);
          });
          
          resultsGrid.appendChild(resultItem);
          return;
        }
        
        // 显示处理成功的图片
        const resultItem = document.createElement('div');
        resultItem.className = 'bg-white rounded-lg overflow-hidden border border-gray-100 shadow-sm';
        
        resultItem.innerHTML = `
          <div class="aspect-video bg-neutral flex items-center justify-center">
            <img src="${image.croppedSrc}" alt="裁剪后的 ${image.name}" class="max-w-full max-h-full">
          </div>
          <div class="p-3">
            <p class="text-sm font-medium truncate">${image.name}</p>
            <p class="text-xs text-gray-500 mb-2">${Math.round(cropData[index].width)} × ${Math.round(cropData[index].height)}</p>
            <button class="download-btn btn-primary w-full text-sm py-1" data-index="${index}">
              <i class="fa fa-download"></i>
              <span>下载</span>
            </button>
          </div>
        `;
        
        resultsGrid.appendChild(resultItem);
      });
      
      // 添加下载事件
      document.querySelectorAll('.download-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.currentTarget.dataset.index);
          downloadImage(images[index]);
        });
      });
    }

    // 下载单张图片
    function downloadImage(image) {
      if (!image.croppedSrc) return;
      
      const link = document.createElement('a');
      // 移除文件名扩展名并添加"_cropped"后缀
      const fileName = image.name.replace(/(\.[^\.]+)$/, '_cropped$1');
      link.download = fileName;
      link.href = image.croppedSrc;
      document.body.appendChild(link);
      link.click();
      // 延迟移除链接以确保下载完成
      setTimeout(() => {
        document.body.removeChild(link);
      }, 100);
    }

    // 下载所有图片
    function downloadAllImages() {
      // 检查是否有可下载的图片
      const downloadableImages = images.filter(img => img.croppedSrc);
      
      if (downloadableImages.length === 0) {
        alert('没有可下载的图片，请先裁剪图片');
        return;
      }
      
      // 逐个下载，添加延迟避免浏览器限制
      downloadableImages.forEach((image, index) => {
        setTimeout(() => downloadImage(image), index * 500);
      });
    }

    // 切换主题
    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      
      const icon = themeToggle.querySelector('i');
      const text = themeToggle.querySelector('span');
      const header = document.querySelector('header');
      const footer = document.querySelector('footer');
      
      if (document.body.classList.contains('dark-mode')) {
        icon.className = 'fa fa-sun-o';
        text.textContent = '切换为亮色';
        document.body.classList.add('bg-gray-900', 'text-white');
        document.body.classList.remove('bg-gray-50', 'text-dark');
        header.classList.add('bg-gray-800', 'border-gray-700');
        header.classList.remove('bg-white', 'border-gray-200');
        footer.classList.add('bg-gray-800', 'border-gray-700', 'text-gray-400');
        footer.classList.remove('bg-white', 'border-gray-200', 'text-gray-500');
      } else {
        icon.className = 'fa fa-moon-o';
        text.textContent = '切换为暗色';
        document.body.classList.add('bg-gray-50', 'text-dark');
        document.body.classList.remove('bg-gray-900', 'text-white');
        header.classList.add('bg-white', 'border-gray-200');
        header.classList.remove('bg-gray-800', 'border-gray-700');
        footer.classList.add('bg-white', 'border-gray-200', 'text-gray-500');
        footer.classList.remove('bg-gray-800', 'border-gray-700', 'text-gray-400');
      }
    }

    // 初始化应用
    function init() {
      initEventListeners();
      
      // 默认选中1:1比例
      document.querySelector('.ratio-btn[data-ratio="1:1"]').click();
    }

    // 启动应用
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>